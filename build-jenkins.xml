<?xml version="1.0" encoding="utf-8" ?>
<project name="sample-apps" default="build-webapps" basedir=".">
  <import file="build-common.xml"/>

  <target name="clean" description="クリーンアップ">
    <delete dir="${dest.dir}" />
  </target>


  <target name="prepare">
    <mkdir dir="${dest.dir}" />
    <mkdir dir="${dest.java.dir}" />
    <mkdir dir="${dest.test.dir}" />
    <mkdir dir="${result.dir}" />
  </target>


  <target name="compile-main" depends="prepare">
    <!-- リソースのコピー -->
    <copy todir="${dest.java.dir}">
       <fileset dir="${src.java.dir}">
         <patternset refid="resource"/>
       </fileset>
    </copy>
    <javac destdir="${dest.java.dir}" debug="on" debuglevel="lines,vars,source"
           optimize="off" deprecation="on" encoding="utf-8"
           includeAntRuntime="off">
      <src path="${src.java.dir}" />
      <classpath refid="base.classpath" />
    </javac>
  </target>


  <target name="build-webapps" description="WARファイルの作成" depends="compile-main">
    <war destfile="${dest.dir}/${ant.project.name}.war"
         update="true" duplicate="preserve"
         webxml="${src.web.dir}/WEB-INF/web.xml">
      <classes dir="${dest.java.dir}" />
      <lib file="${lib.compile.dir}/*.jar" />
      <fileset dir="${src.web.dir}" excludes="**/web.xml" />
    </war>
  </target>


  <target name="javadoc" depends="prepare" description="Javadocの作成">
    <javadoc sourcepath="${src.java.dir}" destdir="${dest.javadoc.dir}"
             packagenames="com.example.*"
             classpathref="base.classpath"
             encoding="utf-8" />
  </target>


  <target name="compile-test" depends="compile-main">
    <!-- リソースのコピー -->
    <copy todir="${dest.test.dir}">
       <fileset dir="${src.test.dir}">
         <patternset refid="resource"/>
       </fileset>
    </copy>
    <javac destdir="${dest.test.dir}" debug="on" debuglevel="lines,vars,source"
           optimize="off" deprecation="on" encoding="utf-8"
           includeAntRuntime="off">
      <src path="${src.test.dir}" />
      <classpath refid="test.classpath" />
      <classpath location="${dest.java.dir}" />
    </javac>
  </target>


  <target name="test" depends="compile-test" description="テストの実行">
    <delete dir="${result.test.dir}" />
    <mkdir dir="${result.test.dir}" />

    <junit fork="on" printsummary="on" maxmemory="256m">
      <classpath location="${dest.test.dir}" />
      <classpath location="${dest.java.dir}" />
      <classpath refid="test.classpath" />

      <formatter type="xml" />
      <batchtest todir="${result.test.dir}">
        <fileset dir="${dest.test.dir}"/>
      </batchtest>
    </junit>
  </target>


  <target name="release" depends="clean, test, build-webapps, javadoc"
                         description="リリースモジュールの作成">
    <zip destfile="${dest.dir}/${ant.project.name}.zip">
      <fileset file="${dest.dir}/${ant.project.name}.war"/>
      <zipfileset dir="${dest.javadoc.dir}" prefix="javadoc"/>
    </zip>
  </target>


</project>
