// apply plugin: 'java' としなくても，以下のようにまとめて書ける
apply {
  plugin 'java'
  plugin 'war'
  plugin 'jetty'
}

// jarファイルの名前
archivesBaseName = "sample-apps"
// javacのオプションに encoding=UTF-8 を追加する
[compileJava, compileTestJava]*.options*.encoding = 'UTF-8'

// mavenリポジトリを利用する
repositories {
  mavenCentral()
}

// 依存ライブラリはローカルにあるJarファイルを直接参照
dependencies {
  testCompile 'junit:junit:4.10'
}

// checkstyleとfindbugsの設定
apply {
  plugin 'checkstyle'
  plugin 'findbugs'
  plugin 'pmd'
  plugin 'jdepend'
}

checkstyleMain { ignoreFailures = true }
checkstyleTest { ignoreFailures = true }
findbugsMain { ignoreFailures = true }
findbugsTest { ignoreFailures = true }
pmdMain { ignoreFailures = true }
pmdTest { ignoreFailures = true }

// カバレッジ測定（jacoco）の設定
//   https://gist.github.com/1657770 より
test {
  jvmArgs "-javaagent:tool/jacoco-0.5.6/lib/jacocoagent.jar=destfile=${buildDir}/coverage-results/jacoco.exec",
      '-Djacoco=true',
      '-Xms128m',
      '-Xmx512m',
      '-XX:MaxPermSize=128m'

  doFirst {
    delete "${buildDir}/coverage-results"
  }

  doLast {
    ant {
      taskdef(name: 'jacocoreport', classname: 'org.jacoco.ant.ReportTask') {
        classpath path: "tool/jacoco-0.5.6/lib/jacocoant.jar"
      }

      mkdir dir: "${buildDir}/reports/coverage"

      jacocoreport {
        executiondata { file: "${buildDir}/coverage-results/jacoco.exec" }

        structure(name: archivesBaseName) {
          classfiles { fileset(dir: "${buildDir}/classes/main") }
          sourcefiles(encoding: 'UTF-8') { fileset(dir: 'src/main/java') }
        }

        xml destfile: "${buildDir}/reports/coverage/jacoco.xml"
        html destdir: "${buildDir}/reports/coverage"
      }
    }
  }
}
